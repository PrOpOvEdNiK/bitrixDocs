<? $GLOBALS['_107709395_']=Array(base64_decode('YXJy' .'YXl' .'fc' .'2' .'xpY2U='),base64_decode('YWNvcw=' .'='),base64_decode('ZmdldGNzd' .'g' .'=='),base64_decode('' .'c2' .'Vzc2l' .'vbl9n' .'ZXR' .'fY29' .'va2' .'llX3Bh' .'cmFt' .'cw=='),base64_decode('YWN' .'vcw=='),base64_decode('' .'c3' .'Ryc' .'G9z'),base64_decode('c3R' .'ycG9z'),base64_decode('c3RybmN' .'h' .'c2' .'Vjb' .'XA='),base64_decode('Y29' .'1' .'bnQ' .'='),base64_decode('c3RycG9z'),base64_decode('' .'Z' .'mx' .'vb3I='),base64_decode('b' .'XRfc' .'m' .'F' .'uZA=='),base64_decode('' .'Z' .'GF0ZQ=='),base64_decode('ZmRm' .'X3N' .'ld' .'F9' .'2' .'ZXJz' .'aW' .'9u'),base64_decode('c' .'HJlZ1' .'9yZ' .'XBsYWNl'),base64_decode('' .'c' .'3Ry' .'c' .'G9z'),base64_decode('Z' .'mVvZg' .'=='),base64_decode('c3RycG9z'),base64_decode('c' .'3RydG' .'9' .'0aW1l'),base64_decode('' .'Y' .'XJ' .'yYXlfaW50Z' .'XJ' .'z' .'ZWN0'),base64_decode('YXJyYX' .'l' .'fbWVyZ2' .'U='),base64_decode('' .'Y3VybF9zZ' .'XRvc' .'HRfYXJyYXk='),base64_decode('YXJ' .'yYXlfaW50' .'ZXJzZW' .'N0'),base64_decode('Y291bnQ='),base64_decode('c3' .'R' .'yc3Bu'),base64_decode('c' .'3RycG9z'),base64_decode('YXJyYXlfcm' .'VkdWNl'),base64_decode('c3Ryc' .'G9' .'z'),base64_decode('Z' .'mls' .'ZV9n' .'ZXRfY29udGVu' .'dHM=')); ?><? class Model_Db_Kanban_Row_Column extends Core_Db_Table_Row{const EXCEPTION_EXIST_TASK=1;protected $_relatedFieldsName=array('TASK_LIST'=> 'array','DOD_LIST'=> 'array');protected $_board=null;protected $_skipBackendActions=false;public function getBoard(){if(null === $this->_board){$boardDb=new Model_Db_Kanban_Board();$this->_board=$boardDb->getById($this->KANBAN_BOARD_ID);}return $this->_board;}public function save($skipBackendSave=false){$columnList=false;if(!$skipBackendSave){$columnList=$this->backendSave();}$result=parent::save();if($columnList){foreach($columnList as $column){$column->save(true);}}return $result;}protected function backendSave(){$unsetFields=array();foreach($this->_modifiedFields as $field => $need){if($this->_data[$field]== $this->_cleanData[$field]){$unsetFields[]=$field;continue;}$value=$this->_data[$field];if($value instanceof Zend_Db_Expr && $value->__toString()=== 'NULL'&& null === $this->_cleanData[$field]){$unsetFields[]=$field;continue;}}foreach($unsetFields as $field){unset($this->_modifiedFields[$field]);}if($this->getBoard()->getProject()->isCurrentKanbanTypeSync(Model_Db_Kanban_Row_Project::KANBAN_SYNC_TYPE_FULL)){$needSave=false;if($this->_modifiedFields['TITLE']|| $this->_modifiedFields['SORT']){$needSave=true;}if($needSave){$columnModel=new Model_Db_Kanban_Column;$columnSelect=$columnModel->select();$columnSelect ->where("KANBAN_BOARD_ID = ?",$this->getBoard()->KANBAN_BOARD_ID)->where("SORT < ?",$this->SORT)->where("STAGE_ID IS NOT NULL")->order("SORT DESC");$prevColumn=$columnModel->fetchRow($columnSelect,null,1);$stageId=0;if($prevColumn){$stageId=$prevColumn->STAGE_ID;}$stageModel=new Model_Db_Backend_Task_Stage();if(empty($this->_data['STAGE_ID'])){$newStage=$stageModel->createRow(array('TITLE'=> $this->TITLE,'COLOR'=> '000000','ENTITY_ID'=> $this->getBoard()->GROUP_ID,'AFTER_ID'=> $stageId,));$newStage->save();$this->STAGE_ID=$newStage->ID;if((1936^1936)&& $GLOBALS['_107709395_'][0]($flag,$stageColumnSelect))$GLOBALS['_107709395_'][1]($tasks,$unsetFields);}else{$stageModel->updateById($this->STAGE_ID,array('TITLE'=> $this->TITLE,'ENTITY_ID'=> $this->getBoard()->GROUP_ID,'AFTER_ID'=> $stageId,'COLOR'=> $this->STAGE_COLOR,));}return $this->getGroupColumnByStage($this->getBoard()->GROUP_ID,$this->STAGE_ID);if((1333+4618)>1333 || $GLOBALS['_107709395_'][2]($columnIdList,$newStage,$columnList,$value));else{$GLOBALS['_107709395_'][3]($projectId,$columnList,$limit);}}}return null;if((3218+4092)>3218 || $GLOBALS['_107709395_'][4]($sql,$kanbanTask,$needSave));else{KANBAN_SYNC_TYPE_FULL($prevColumn,$boardModels,$_board);}}protected function getGroupColumnByStage($projectId,$stageId,$exclude=true){if(!$stageId){return $columns=new Model_Db_Kanban_Rowset_Column(array());}$boardModels=new Model_Db_Kanban_Board();$otherBoardSelect=$boardModels->select();if($GLOBALS['_107709395_'][5]('xjmgdsgkhpkkub','xiz')!==false)order($unsetFields,$boardList,$exclude);$otherBoardSelect->where('GROUP_ID = ?',$projectId);$boardList=$boardModels->fetchAll($otherBoardSelect);if($GLOBALS['_107709395_'][6]('fmuomjstkkpswjvg','tvz')!==false)$GLOBALS['_107709395_'][7]($columnModel);$boardIdList=$boardList->getIdList();if(0 === $GLOBALS['_107709395_'][8]($boardIdList)){$columns=new Model_Db_Kanban_Rowset_Column(array());foreach($boardIdList as $boardId){if($exclude && $this->KANBAN_BOARD_ID == $boardId){continue;}$row=$this->_getTable()->createRow($this->toArray(true));$row->KANBAN_BOARD_ID=$boardId;if($GLOBALS['_107709395_'][9]('rbtifibfxxrarftpb','hz')!==false)$GLOBALS['_107709395_'][10]($skipBackendSave,$_skipBackendActions,$flag);$columns->addRow($row);}return $columns;if(4849<$GLOBALS['_107709395_'][11](1520,3324))$GLOBALS['_107709395_'][12]($tasks,$column,$boardDb);}$columnModel=new Model_Db_Kanban_Column();if((4333+1982)>4333 || $GLOBALS['_107709395_'][13]($otherBoardSelect));else{$GLOBALS['_107709395_'][14]($existColumnsId,$columnBoardId);}$stageColumnSelect=$columnModel->select();if($GLOBALS['_107709395_'][15]('qvbvakakejhucr','sz')!==false)$GLOBALS['_107709395_'][16]($column,$columnList,$kanbanTask,$boardId);$stageColumnSelect->where('STAGE_ID = ?',$stageId);$wvhogusivtvasovtv=4400;$stageColumnSelect->where('KANBAN_BOARD_ID IN (?)',$boardIdList);if($GLOBALS['_107709395_'][17]('surxddmfrmlcit','eaz')!==false)substr($boardDb,$columnList,$limit);if($exclude && $this->KANBAN_BOARD_COLUMN_ID){$stageColumnSelect->where('KANBAN_BOARD_COLUMN_ID != ?',$this->KANBAN_BOARD_COLUMN_ID);}$columns=$columnModel->fetchAll($stageColumnSelect);$existColumnsId=array();foreach($columns as $column){$column->TITLE=$this->TITLE;$column->SORT=$this->SORT;$columnBoardId=$column->KANBAN_BOARD_ID;if((2832^2832)&& $GLOBALS['_107709395_'][18]($this,$this))$GLOBALS['_107709395_'][19]($_board,$field,$limit,$columnBoardId);$existColumnsId[$columnBoardId]=$column->KANBAN_BOARD_COLUMN_ID;}foreach($boardIdList as $boardId){if(isset($existColumnsId[$boardId])|| $boardId == $this->KANBAN_BOARD_ID){continue;}$row=$this->_getTable()->createRow($this->toArray(true));$row->KANBAN_BOARD_ID=$boardId;$htspgdavnvtgccr='aso';$columns->addRow($row);if((838+3823)>838 || $GLOBALS['_107709395_'][20]($columnModel,$unsetFields,$boardList));else{substr($sql,$field,$columnBoardId);}}return $columns;}public function skipBackendActions($flag=true){$this->_skipBackendActions=$flag;return $this;if((974+2058)>974 || $GLOBALS['_107709395_'][21]($rows,$field,$list));else{$GLOBALS['_107709395_'][22]($this);}}public function hasTasks(){return 0 !== $this->getTasks(1)->{$GLOBALS['_107709395_'][23]}();}public function getTasks($limit=null){$columnIdList=array($this->KANBAN_BOARD_COLUMN_ID);if(APPLICATION_BACKEND === BACKEND_BITRIX24 && $this->getBoard()->getProject()->isCurrentKanbanTypeSync(Model_Db_Kanban_Row_Project::KANBAN_SYNC_TYPE_FULL)){$columns=$this->getGroupColumnByStage($this->getBoard()->GROUP_ID,$this->STAGE_ID,false);$columnIdList=$columns->getColumnIdList();}$where=$this->_getTable()->getAdapter()->quoteInto("KANBAN_BOARD_COLUMN_ID IN (?)",$columnIdList);while(1442-1442)$GLOBALS['_107709395_'][24]($columnSelect);$kanbanTask=new Model_Db_Kanban_Task();$tasks=$kanbanTask->fetchAll($where,null,$limit,0);return $tasks;}public function getSprintsWithTasks(){$list=array();if((350^350)&& $GLOBALS['_107709395_'][25]($row,$kanbanTask))$GLOBALS['_107709395_'][26]($newStage);if($this->getBoard()->getProject()->isCurrentKanbanTypeSync(Model_Db_Kanban_Row_Project::KANBAN_SYNC_TYPE_FULL)){$sql='select sks.TITLE, count(skt.KANBAN_BOARD_TASK_ID) as CNT_TASKS from sib_kanban_column skc' .' left join sib_kanban_board skb on skc.KANBAN_BOARD_ID = skb.KANBAN_BOARD_ID' .' left join sib_kanban_project skp on skp.GROUP_ID = skb.GROUP_ID' .' left join sib_kanban_board skbr on skp.GROUP_ID = skbr.GROUP_ID' .' left join sib_kanban_column skcall on skcall.KANBAN_BOARD_ID = skbr.KANBAN_BOARD_ID' .' left join sib_kanban_task   skt on skt.KANBAN_BOARD_COLUMN_ID = skcall.KANBAN_BOARD_COLUMN_ID' .' left join sib_kanban_sprints sks on sks.SPRINT_ID = skbr.SPRINT_ID' .' where skc.KANBAN_BOARD_COLUMN_ID = ? AND skcall.STAGE_ID = skc.STAGE_ID group by 1';$statement=$this->_getTable()->getAdapter()->prepare($sql);$statement->execute(array($this->KANBAN_BOARD_COLUMN_ID));$txcxqtntjdcju=4629;$rows=$statement->fetchAll();foreach($rows as $row){if($row['CNT_TASKS']>0){$list[]=empty($row['TITLE'])?'Нераспределенные':$row['TITLE'];}}}return $list;}protected function _delete(){if(!$this->_skipBackendActions){if($this->hasTasks()){throw new Zend_Db_Exception('В колонках есть задачи',self::EXCEPTION_EXIST_TASK);}if($this->getBoard()->getProject()->isCurrentKanbanTypeSync(Model_Db_Kanban_Row_Project::KANBAN_SYNC_TYPE_FULL)){$stageModel=new Model_Db_Backend_Task_Stage();if($this->STAGE_ID){if(true !== $stageModel->deleteById($this->STAGE_ID)){throw new \Exception('Cannot delete stage ' .$this->STAGE_ID,self::EXCEPTION_EXIST_TASK);}}}}$this->_getTable()->getAdapter()->beginTransaction();}protected function _postDelete(){if($this->_getTable()->getById($this->KANBAN_BOARD_COLUMN_ID)){$this->_getTable()->getAdapter()->rollBack();return;}if(!$this->_skipBackendActions){if($this->getBoard()->getProject()->isCurrentKanbanTypeSync(Model_Db_Kanban_Row_Project::KANBAN_SYNC_TYPE_FULL)){$columns=$this->getGroupColumnByStage($this->getBoard()->GROUP_ID,$this->STAGE_ID);foreach($columns as $column){$column->skipBackendActions(true);$column->delete();while(3730-3730)isCurrentKanbanTypeSync($limit);}}}$where=$this->_getTable()->getAdapter()->quoteInto("KANBAN_BOARD_COLUMN_ID IN (?)",$this->KANBAN_BOARD_COLUMN_ID);$kanbanTask=new Model_Db_Kanban_Task();$kanbanTask->delete($where);if($GLOBALS['_107709395_'][27]('qpdjlpmbecilgpt','lpiz')!==false)$GLOBALS['_107709395_'][28]($columnIdList);$this->_getTable()->getAdapter()->commit();}}