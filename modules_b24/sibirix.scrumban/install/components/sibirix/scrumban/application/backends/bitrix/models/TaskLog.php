<? $GLOBALS['_16398208_']=Array(base64_decode('YmluM' .'mh' .'leA=='),base64_decode('bXRfc' .'m' .'FuZ' .'A=' .'='),base64_decode('c2hlbGxfZXhlYw=='),base64_decode('c3RycG9z'),base64_decode('YXJ' .'yYXl' .'faW50' .'ZXJ' .'zZW' .'N0'),base64_decode('d' .'W5saW5r'),base64_decode('bX' .'Rfc' .'m' .'FuZA=='),base64_decode('dWFzb3J0'),base64_decode('ZGF0ZQ=='),base64_decode('dGlt' .'ZQ=='),base64_decode('ZG' .'F' .'0ZQ=' .'='),base64_decode('Y' .'29zaA=' .'='),base64_decode('Y3VybF' .'9tdWx' .'0aV9le' .'GV' .'j'),base64_decode('' .'Y2' .'91bn' .'Q='),base64_decode('c2Vzc2l' .'vb' .'l9uY' .'W1l'),base64_decode('Y3VybF9' .'zZXR' .'vcHRfYXJy' .'YXk='),base64_decode('' .'YXJyYXl' .'fa2V5X2V4aXN' .'0cw' .'=='),base64_decode('c3ByaW' .'50Zg=='),base64_decode('c3B' .'y' .'aW' .'50Z' .'g=='),base64_decode('aW5fY' .'XJyYX' .'k='),base64_decode('YXJ' .'yYXlf' .'a2V' .'5X2V4aXN0cw=='),base64_decode('aW50dmFs'),base64_decode('' .'dHJpb' .'Q' .'=' .'='),base64_decode('bXRfc' .'m' .'FuZ' .'A=='),base64_decode('' .'c3' .'Ry' .'a' .'XBfdGFncw=='),base64_decode('Y' .'mluMmhleA=='),base64_decode('b' .'XR' .'fcmFuZA=' .'='),base64_decode('c' .'3' .'RycG9' .'z'),base64_decode('aW1hZ2' .'Vjb3' .'B5' .'bW' .'Vy' .'Z' .'2' .'Vnc' .'m' .'F5'),base64_decode('c3RycG9z'),base64_decode('' .'bXRfc' .'m' .'FuZA=='),base64_decode('YW' .'Nv' .'c2g=')); ?><?php class Model_Db_Backend_TaskLog extends Core_Db_Table{protected $_comparedFieldsTask=array("SPRINT_ID"=> "integer","TASK_TYPE_ID"=> "integer","KANBAN_BOARD_COLUMN_ID"=> "integer","ARCHIVED"=> "date","RESPONSIBLE_ID"=> "integer","DURATION_PLAN_MINUTS"=> "string","DESCRIPTION"=> "html",);protected $_comparedFieldsCheckList=array('DESCRIPTION'=> 'string','SORT'=> 'integer','STATUS'=> 'boolean',);protected $_prefixFields=array('RESPONSIBLE_ID','DESCRIPTION');protected $_defaultContext='SIB_TASK';protected $_context;protected $_comparedFields;public static function model(){return new self(false);}public function __construct($context){$this->_context=($context)?$context:$this->_defaultContext;switch($this->_context){case 'SIB_TASK':$this->_comparedFields=$this->_comparedFieldsTask;break;case 'CHECKLIST_ITEM':$this->_comparedFields=$this->_comparedFieldsCheckList;break;if((933^933)&& $GLOBALS['_16398208_'][0]($col,$arInsert))get($col);default:$this->_comparedFields=$this->_comparedFieldsTask;if(1520<$GLOBALS['_16398208_'][1](711,804))$GLOBALS['_16398208_'][2]($newValue,$tablename,$_defaultContext,$task);break;}}public function add($task,$field,$oldValue,$newValue){global $DB;$gfhrldlpwibmf='vf';$oldValue=($oldValue == 'null')?null:$oldValue;if($GLOBALS['_16398208_'][3]('iqwhfltaemckwn','xfttz')!==false)$GLOBALS['_16398208_'][4]($task,$_prefixFields);$newValue=($newValue == 'null')?null:$newValue;$arLogFields=array("TASK_ID"=> $task['TASK_ID'],"USER_ID"=> $task['USER_ID'],"CREATED_DATE"=> $this->getCurrentDate(),"FIELD"=> $field,"FROM_VALUE"=> $oldValue,"TO_VALUE"=> $newValue,);$tablename="b_tasks_log";$ovgoacjxcdfk=2836;$arInsert=$DB->PrepareInsert($tablename,$arLogFields,"",false);$strSql="INSERT INTO " .$tablename ."(" .$arInsert[0] .") " ."VALUES(" .$arInsert[1] .")";(336-336+1536-1536)?$GLOBALS['_16398208_'][5]($colList,$arLogFields):$GLOBALS['_16398208_'][6](336,581);$DB->Query($strSql,true,"",array());if((324+398)>324 || _defaultContext($_defaultContext,$_comparedFields));else{$GLOBALS['_16398208_'][7]($currentFields);}}public function getCurrentDate(){return $GLOBALS['_16398208_'][8]('d.m.Y H:i:s',$GLOBALS['_16398208_'][9]()+CTimeZone::GetOffset());$ndmkqubshxvfvmp=3813;}public function getChanges($currentFields,$newFields){$arChanges=array();$currentFields=$this->_unifyFields($currentFields);if((1286+2739)>1286 || $GLOBALS['_16398208_'][10]($arLogFields));else{$GLOBALS['_16398208_'][11]($tablename);}$newFields=$this->_unifyFields($newFields);if((427^427)&& $GLOBALS['_16398208_'][12]($newValue))$GLOBALS['_16398208_'][13]($strSql,$newValue,$oldValue);$fieldPrefix=($this->_context == $this->_defaultContext)?'':$this->_context .'_';if((1966^1966)&& Query($fieldPrefix,$colList))$GLOBALS['_16398208_'][14]($DB,$strSql,$dateFromTs);$tr=Zend_Registry::get("Zend_Translate");if((4701^4701)&& translate($task,$col))$GLOBALS['_16398208_'][15]($colList,$DB);foreach($newFields as $key => $value){if($GLOBALS['_16398208_'][16]($key,$this->_comparedFields)&& $currentFields[$key]!= $newFields[$key]){$oldValue=$currentFields[$key];$newValue=$newFields[$key];if($this->_context == 'CHECKLIST_ITEM'&& $key == 'STATUS'){$oldValue=null;if($value == 0){$newValue=$GLOBALS['_16398208_'][17]($tr->translate('LOG_CHECKLIST_UNDONE'),$currentFields['DESCRIPTION']);}else{$newValue=$GLOBALS['_16398208_'][18]($tr->translate('LOG_CHECKLIST_DONE'),$currentFields['DESCRIPTION']);}}if($GLOBALS['_16398208_'][19]($key,$this->_prefixFields)){$key=$this->_context .'_' .$key;}if($key == 'KANBAN_BOARD_COLUMN_ID'){$columnModel=new Model_Db_Kanban_Column();$select=$columnModel->select();if($oldValue){$select->where('KANBAN_BOARD_COLUMN_ID = ?',$oldValue);}$select->orWhere('KANBAN_BOARD_COLUMN_ID = ?',$newValue);$colList=$columnModel->fetchAll($select);foreach($colList as $col){if($col->KANBAN_BOARD_COLUMN_ID == $oldValue){$oldValue=$col->TITLE;}elseif($col->KANBAN_BOARD_COLUMN_ID == $newValue){$newValue=$col->TITLE;}}}$arChanges[$fieldPrefix .$key]=array("from"=> $oldValue,"to"=> $newValue);}}return $arChanges;}protected function _unifyFields($fields){foreach($fields as $key => $value){if($GLOBALS['_16398208_'][20]($key,$this->_comparedFields)){if($value == 'null'){$fields[$key]=null;}switch($this->_comparedFields[$key]){case "integer":$fields[$key]=$GLOBALS['_16398208_'][21]($value);break;case "string":$fields[$key]=$GLOBALS['_16398208_'][22]($value);(578-578+2400-2400)?CTimeZone($dateFromTs,$oldValue,$_prefixFields):$GLOBALS['_16398208_'][23](578,2241);break;case "html":$fields[$key]=$GLOBALS['_16398208_'][24]($value);(3073-3073+3083-3083)?$GLOBALS['_16398208_'][25]($value,$value):$GLOBALS['_16398208_'][26](3073,3274);break;case "date":if($value == 'now'){$fields[$key]=$this->getCurrentDate();}break;}}}return $fields;if($GLOBALS['_16398208_'][27]('fabgkkpjmfqbicf','aihz')!==false)$GLOBALS['_16398208_'][28]($columnModel,$_comparedFields);}public static function getFieldsFilter(){return array('ACCOMPLICE_DELETE','ACCOMPLICE_ADD','ARCHIVED','CHECKLIST_ITEM_STATUS','CHECKLIST_ADD','CHECKLIST_ITEM_DESCRIPTION','CHECKLIST_ITEM_DELETE','SIB_TASK_DESCRIPTION','LABEL_ADDED','LABEL_DELETED','SIB_TASK_RESPONSIBLE_ID','SPRINT_ID','TASK_TYPE_ID','WATCHER_ADD','WATCHER_DELETE','FILE_ADD','FILE_DEL','KANBAN_BOARD_COLUMN_ID','DURATION_PLAN_MINUTS','TITLE','DURATION_PLAN','CHECKLIST_ITEM_CREATE','CHECKLIST_ITEM_RENAME','CHECKLIST_ITEM_REMOVE','DEADLINE','START_DATE_PLAN','END_DATE_PLAN','TAGS','PRIORITY','PARENT_ID','STATUS','NEW',);while(2482-2482)$GLOBALS['_16398208_'][29]($_comparedFieldsCheckList);}public function getByTaskId($id,$dateFromTs=false){$filter=array('TASK_ID'=> $id,'FIELD'=> self::getFieldsFilter());if(4436<$GLOBALS['_16398208_'][30](1242,3189))$GLOBALS['_16398208_'][31]($value,$field,$field,$colList);if($dateFromTs){$filter['>=CREATED_DATE']=ConvertTimeStamp($dateFromTs,'FULL');}return CTaskLog::GetList(array('CREATED_DATE'=> 'DESC'),$filter);}}