(function(){BX.namespace("BX.Call");BX.Call.State={Incoming:"Incoming"};BX.Call.UserState={Idle:"Idle",Calling:"Calling",Declined:"Declined",Ready:"Ready",Connecting:"Connecting",Connected:"Connected",Failed:"Failed"};BX.Call.Type={Instant:1,Permanent:2};BX.Call.Provider={Plain:"Plain",Voximplant:"Voximplant",Janus:"Janus"};BX.Call.StreamTag={Main:"main",Screen:"screen"};BX.Call.Direction={Incoming:"Incoming",Outgoing:"Outgoing"};BX.Call.Event={onUserInvited:"onUserInvited",onUserStateChanged:"onUserStateChanged",onUserVoiceStarted:"onUserVoiceStarted",onUserVoiceStopped:"onUserVoiceStopped",onLocalMediaReceived:"onLocalMediaReceived",onLocalMediaStopped:"onLocalMediaStopped",onDeviceListUpdated:"onDeviceListUpdated",onRTCStatsReceived:"onRTCStatsReceived",onCallFailure:"onCallFailure",onStreamReceived:"onStreamReceived",onStreamRemoved:"onStreamRemoved",onDestroy:"onDestroy"};var e={createCall:"im.call.create",createChildCall:"im.call.createChildCall",getPublicChannels:"pull.channel.public.list",getCall:"im.call.get"};var l=false;BX.Call.Engine=function(){this.debugFlag=false;if(!l){throw new Error("Do not use this constructor directly, use BX.Call.Engine.getInstance instead")}this.calls={};this.userId=BX.message("USER_ID");this.init()};BX.Call.Engine.getInstance=function(){return BX.CallEngine};BX.Call.Engine.prototype.init=function(){BX.addCustomEvent("onPullEvent-im",this.__onPullEvent.bind(this));BX.addCustomEvent("onPullClientEvent-im",this.__onPullClientEvent.bind(this))};BX.Call.Engine.prototype.getCurrentUserId=function(){return this.userId};BX.Call.Engine.prototype.createCall=function(l){var a=this;return new Promise(function(t,n){var i=l.type||BX.Call.Type.Instant;var r=l.provider||a.getDefaultProvider();var o={type:i,provider:r,entityType:l.entityType,entityId:l.entityId,userIds:BX.type.isArray(l.userIds)?l.userIds:[]};var s={callParams:[e.createCall,o],publicChannels:[e.getPublicChannels,{USERS:"$result[callParams][users]"}]};BX.rest.callBatch(s,function(e){if(e.callParams.error()){var i=e.callParams.error().getError();return n({code:i.error,message:i.error_description})}var r=e.callParams.data();var o=r.call;var s=a.__getCallFabric(o["PROVIDER"]);var c=s.createCall({id:parseInt(o["ID"],10),instanceId:a.getUuidv4(),direction:BX.Call.Direction.Outgoing,users:r.users,videoEnabled:l.videoEnabled==true,enableMicAutoParameters:l.enableMicAutoParameters!==false,associatedEntity:o.ASSOCIATED_ENTITY,events:{onDestroy:a.__onCallDestroy.bind(a)},debug:l.debug===true});var u=e.publicChannels.data();BX.PULL.setPublicIds(Object.values(u));a.calls[o["ID"]]=c;if(r.userData){BX.MessengerCommon.updateUserData(r.userData)}t({call:c,isNew:r.isNew})})})};BX.Call.Engine.prototype.createChildCall=function(l,a,t){var n=this;return new Promise(function(i,r){if(!n.calls[l]){return r("Parent call is not found")}var o=n.calls[l];var s={parentId:l,newProvider:a,newUsers:t};var c={callParams:[e.createChildCall,s],publicChannels:[e.getPublicChannels,{USERS:"$result[callParams][users]"}]};BX.rest.callBatch(c,function(e){var l=e.callParams.data();var a=l.call;var t=n.__getCallFabric(a["PROVIDER"]);var r=t.createCall({id:parseInt(a["ID"],10),instanceId:n.getUuidv4(),parentId:a["PARENT_ID"],direction:BX.Call.Direction.Outgoing,users:l.users,videoEnabled:o.isVideoEnabled(),enableMicAutoParameters:o.enableMicAutoParameters!==false,associatedEntity:a.ASSOCIATED_ENTITY,events:{onDestroy:n.__onCallDestroy.bind(n)}});var s=e.publicChannels.data();BX.PULL.setPublicIds(Object.values(s));n.calls[a["ID"]]=r;i({call:r,isNew:l.isNew})})})};BX.Call.Engine.prototype.getCall=function(e,l){var a=this.__getCallFabric(e["PROVIDER"]);var t=a.createCall({id:parseInt(e["ID"],10),instanceId:this.getUuidv4(),direction:BX.Call.Direction.Outgoing,users:l,events:{onDestroy:this.__onCallDestroy.bind(this)}});this.calls[e["ID"]]=t;return t};BX.Call.Engine.prototype.getCallWithId=function(l){var a=this;return new Promise(function(t,n){if(a.calls[l]){return t(a.calls[l])}BX.ajax.runAction(e.getCall,{data:{callId:l}}).then(function(e){if(e.state==="success"){var l=e.data.call;t({call:a.getCall(l),isNew:false})}else if(e.state==="error"){n(e.errors[0])}})})};BX.Call.Engine.prototype.getUuidv4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var l=Math.random()*16|0,a=e=="x"?l:l&3|8;return a.toString(16)})};BX.Call.Engine.prototype.__onPullEvent=function(e,l,a){var t={"Call::incoming":this.__onPullIncomingCall.bind(this)};if(t[e]){t[e].call(this,l,a)}else if(e.substr(0,6)==="Call::"&&l["call"]){var n=l["call"];var i=n["ID"];if(this.calls[i]){this.calls[i].__onPullEvent(e,l,a)}}};BX.Call.Engine.prototype.__onPullClientEvent=function(e,l,a){if(e.substr(0,6)==="Call::"&&l["callId"]){var t=l["callId"];if(this.calls[t]){this.calls[t].__onPullEvent(e,l,a)}}};BX.Call.Engine.prototype.__onPullIncomingCall=function(e,l){if(l.server_time_ago>30){console.error("Call was started too long time ago");return}var a=e.call;var t=parseInt(a.ID,10);var n;if(e.publicIds){BX.PULL.setPublicIds(Object.values(e.publicIds))}if(e.userData){BX.MessengerCommon.updateUserData(e.userData)}if(this.calls[t]){n=this.calls[t]}else{var i=this.__getCallFabric(a.PROVIDER);n=i.createCall({id:t,instanceId:this.getUuidv4(),parentId:a.PARENT_ID||null,callFromMobile:e.isMobile===true,direction:BX.Call.Direction.Incoming,users:e.users,initiatorId:e.senderId,associatedEntity:a.ASSOCIATED_ENTITY,events:{onDestroy:this.__onCallDestroy.bind(this)}});this.calls[t]=n}if(n){BX.onCustomEvent(window,"CallEvents::incomingCall",[{call:n,video:e.video===true,isMobile:e.isMobile===true}])}};BX.Call.Engine.prototype.__onCallDestroy=function(e){if(this.calls[e.call.id]){delete this.calls[e.call.id]}};BX.Call.Engine.prototype.getDefaultProvider=function(){return BX.Call.Provider.Plain};BX.Call.Engine.prototype.__getCallFabric=function(e){if(e==BX.Call.Provider.Plain){return BX.Call.PlainCallFabric}else if(e==BX.Call.Provider.Voximplant){return BX.Call.VoximplantCallFabric}else if(e==BX.Call.Provider.Janus){return BX.Call.JanusCallFabric}throw new Error("Unknown call provider type "+e)};BX.Call.Engine.prototype.debug=function(e){this.debugFlag=typeof e==="undefined"?true:!!e;return this.debugFlag};BX.Call.Engine.prototype.log=function(){var e=BX.Call.Util.getDateForLog();var l=typeof arguments[0]==="number"?arguments[0]:0;for(var a=l>0?1:0;a<arguments.length;a++){try{e=e+" | "+(typeof arguments[a]=="object"?JSON.stringify(arguments[a]):arguments[a])}catch(l){e=e+" | (circular structure)"}}if(BX.desktop&&BX.desktop.ready()){BX.desktop.log(BX.message("USER_ID")+".video.log",e.substr(3))}if(this.debugFlag){if(console){var t=["Call log ["+BX.Call.Util.getTimeForLog()+"]: "];console.log.apply(this,t.concat(Array.prototype.slice.call(arguments)))}}if(BX.MessengerDebug&&l){BX.MessengerDebug.addLog(l,e)}};BX.Call.PlainCallFabric={createCall:function(e){return new BX.Call.PlainCall(e)}};BX.Call.VoximplantCallFabric={createCall:function(e){return new BX.Call.VoximplantCall(e)}};BX.Call.JanusCallFabric={createCall:function(e){return new BX.Call.JanusCall(e)}};l=true;BX.CallEngine=new BX.Call.Engine;l=false})();
//# sourceMappingURL=engine.map.js